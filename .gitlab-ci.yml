# This YAML recipe builds KStars with INDI support, then runs all tests
# It uses both KDE CI and custom image until tests are stabilised in the KDE CI image
# Build dependencies for the custom image are packaged into image definition 'docker/Dockerfile'

include:
  - local: ".gitlab-ci/common_rules.yml"
  - project: sysadmin/ci-utilities
    file:
      - /gitlab-templates/linux.yml
      - /gitlab-templates/linux-qt6.yml
      - /gitlab-templates/windows-qt6.yml
      - /gitlab-templates/flatpak.yml
      - /gitlab-templates/flatpak-arm64.yml
      - /gitlab-templates/craft-windows-x86-64-qt6.yml
      - /gitlab-templates/craft-windows-appx-qt6.yml
      - /gitlab-templates/craft-macos-x86-64-qt6.yml
      - /gitlab-templates/craft-macos-arm64-qt6.yml

variables:
  # Custom CI images should be prebuilt and pinned (avoid moving 'latest').
  # Override per-project/instance if needed.
  KSTARS_CI_IMAGE: "tallfurryman/kstars-ci@sha256:352e0bca4fc4c6229c7b91951ea9fc24d28353d164d3ad50afce93314b4e4c29"

# Jobs
# Standard build recipes

.standard-build-recipes:
  rules:
    - !reference [.optional-on-forked-repository, rules]
    - !reference [.optional-on-draft-merge-requests, rules]
    - !reference [.optional-on-scheduled-pipeline, rules]
    - !reference [.always-on-master-branch, rules]
    - !reference [.always-on-merge-requests, rules]
    - !reference [.manual-skipped-recipe, rules]

# These jobs are automatically defined by the included templates
# We just need to override their rules - no need to extend anything

suse_tumbleweed_qt610:
  rules:
    - !reference [.always-on-scheduled-pipeline, rules] # Flatpak nightly
    - !reference [.standard-build-recipes, rules]

windows_qt69:
  allow_failure: true # TODO: REMOVE WHEN STELLARSOLVER QT6 IS INCLUDED IN CI IMAGE
  rules:
    - !reference [.standard-build-recipes, rules]

suse_tumbleweed_qt515:
  # This job is likely defined by linux.yml template (Qt5 build)
  allow_failure: true # TODO: REMOVE WHEN STELLARSOLVER QT5 IS INCLUDED IN CI IMAGE
  rules:
    - !reference [.standard-build-recipes, rules]

json-validation:
  rules:
    - !reference [.standard-build-recipes, rules]

astyle-check:
  stage: test
  image: ubuntu:24.04
  rules:
    - !reference [.standard-build-recipes, rules]
  script:
    - apt-get update && apt-get install -y --no-install-recommends astyle git
    - git ls-files -z '*.c' '*.cc' '*.cpp' '*.cxx' '*.h' '*.hh' '*.hpp' '*.hxx' | xargs -0r astyle
      --style=allman
      --align-reference=name
      --indent-switches
      --indent-modifiers
      --indent-classes
      --pad-oper
      --indent-col1-comments
      --lineend=linux
      --max-code-length=124
      --suffix=none
    - git diff --exit-code

# Craft recipes

.craft-recipes:
  rules:
    - !reference [.optional-on-forked-repository, rules]
    - !reference [.optional-on-draft-merge-requests, rules]
    - !reference [.optional-on-scheduled-pipeline, rules]
    - !reference [.always-on-master-branch, rules]
    - !reference [.always-on-stable-release, rules]
    - !reference [.manual-skipped-recipe, rules]

# These craft jobs are also automatically defined by the included templates
craft_windows_qt6_x86_64: # Extended from /gitlab-templates/craft-windows-x86-64-qt6.yml
  needs:
    - windows_qt69
  rules:
    - !reference [.craft-recipes, rules]

craft_macos_qt6_x86_64: # Extended from /gitlab-templates/craft-macos-x86-64-qt6.yml
  timeout: 2h # Signing procedure often exceeds the default 1h
  needs:
    - suse_tumbleweed_qt610 # we don't have a macos check build
  rules:
    - !reference [.craft-recipes, rules]

craft_macos_qt6_arm64: # Extended from /gitlab-templates/craft-macos-arm64-qt6.yml
  timeout: 2h # Signing procedure often exceeds the default 1h
  needs:
    - suse_tumbleweed_qt610 # we don't have a macos check build
  rules:
    - !reference [.craft-recipes, rules]

# Publishing recipes

.publishing-recipes:
  rules:
    - !reference [.always-on-stable-release, rules]
    - !reference [.manual-skipped-recipe, rules]
    - when: never

microsoftstore_qt6:
  needs:
    - craft_windows_qt6_x86_64 # Wait for Windows craft job to complete
  rules:
    - !reference [.publishing-recipes, rules]

flatpak-amd64:
  timeout: 2h
  needs:
    - suse_tumbleweed_qt610
  rules:
    - !reference [.always-on-scheduled-pipeline, rules]
    - !reference [.publishing-recipes, rules]

flatpak-arm64:
  timeout: 2h
  needs:
    - suse_tumbleweed_qt610
  rules:
    - !reference [.always-on-scheduled-pipeline, rules]
    - !reference [.publishing-recipes, rules]

# Custom build recipes - until tests are operational in the KDE CI image

.custom-build-recipes:
  rules:
    - !reference [.optional-on-forked-repository, rules]
    - !reference [.optional-on-draft-merge-requests, rules]
    - !reference [.always-on-merge-requests, rules]
    - !reference [.manual-skipped-recipe, rules]

.custom_build:
  interruptible: true
  image: "$KSTARS_CI_IMAGE"
  variables:
    CCACHE_BASEDIR: "$CI_PROJECT_DIR"
    QT_TEST_TIMEOUT_FUNCTION: "600"
    QT_QPA_PLATFORM: "offscreen"
    KSTARS_TEST_ENABLE_NETWORK: "0"
    CCACHE_DIR: "$CI_PROJECT_DIR/.ccache"
  cache:
    key: "CCACHE-DB-$CI_PROJECT_ID"
    paths: ["${CCACHE_DIR}"]
    when: always
  rules:
    - !reference [.custom-build-recipes, rules]
  before_script:
    - du -hs "${CCACHE_DIR}" || mkdir -p "${CCACHE_DIR}"
    - mkdir -p kstars-build
  after_script:
    - ccache -s

# Run the full validation in one step, stable tests that must not fail
# The artifacts take far too much time to propagate from one step to the other
# The cache is unreliable, and only works on the same runner if there is no shared cache - use it for ccache instead
# Consolidate runner with build packages and build
build-and-test-stable:
  stage: test
  extends: .custom_build
  allow_failure: false
  timeout: 3h
  script:
    - cd kstars-build
    # Build with Qt5 in the custom image. The packaged StellarSolver/INDI stack is Qt5-based in most distros/PPAs.
    - cmake -GNinja -DCMAKE_BUILD_TYPE=Release -DCCACHE_SUPPORT=ON -DBUILD_TESTING=ON -DBUILD_DOC=OFF -DBUILD_WITH_QT6=OFF ..
    - ninja -j8 all
    - rm -rf Testing
    - dbus-run-session -- ctest -T test -L stable -LE unstable --output-on-failure -j8
  after_script:
    - saxon-xslt -u "$(find . -name Test.xml | head -n1)" "$CI_PROJECT_DIR/.gitlab-ci/ctest-to-junit.xsl" > ./junit_result.stable.xml
  artifacts:
    reports:
      junit: ./junit_result.stable.xml

build-and-test-unstable:
  stage: test
  extends: .custom_build
  allow_failure: true
  timeout: 1h
  script:
    - cd kstars-build
    - cmake -GNinja -DCMAKE_BUILD_TYPE=Release -DCCACHE_SUPPORT=ON -DBUILD_TESTING=ON -DBUILD_DOC=OFF -DBUILD_WITH_QT6=OFF ..
    - ninja -j8 all
    - rm -rf Testing
    - dbus-run-session -- ctest -T test -L unstable --output-on-failure -j8
  after_script:
    - saxon-xslt -u "$(find . -name Test.xml | head -n1)" "$CI_PROJECT_DIR/.gitlab-ci/ctest-to-junit.xsl" > ./junit_result.unstable.xml
  artifacts:
    reports:
      junit: ./junit_result.unstable.xml

## Optional Qt6 test job intentionally omitted here:
## - Qt6 builds need a Qt6-based StellarSolver/INDI stack in the image.
